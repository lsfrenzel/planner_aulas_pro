<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turmas - Aula Planner Pro</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
    <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-4">
                    <a href="/" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                        <div class="w-10 h-10 bg-primary-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-graduation-cap text-white text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold text-gray-800 dark:text-white">Aula Planner Pro</h1>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Gerenciar Turmas</p>
                        </div>
                    </a>
                </div>
                <div class="flex items-center gap-3">
                    <a href="/" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors flex items-center gap-2">
                        <i class="fas fa-home"></i>
                        <span class="hidden sm:inline">Inicio</span>
                    </a>
                    <a href="/dashboard" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors flex items-center gap-2">
                        <i class="fas fa-table"></i>
                        <span class="hidden sm:inline">Dashboard</span>
                    </a>
                    <button onclick="toggleTheme()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        <i class="fas fa-moon text-gray-600 dark:hidden"></i>
                        <i class="fas fa-sun text-yellow-400 hidden dark:block"></i>
                    </button>
                    <div class="flex items-center gap-2 pl-3 border-l border-gray-200 dark:border-gray-700">
                        {% if has_photo %}
                        <img src="/api/user-photo/{{ user_id }}" alt="Foto de perfil" class="w-8 h-8 rounded-full object-cover border-2 border-primary-200">
                        {% else %}
                        <div class="w-8 h-8 bg-primary-100 dark:bg-primary-900/30 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-primary-500 text-sm"></i>
                        </div>
                        {% endif %}
                        <span class="text-sm text-gray-600 dark:text-gray-300">{{ user.user_name }}</span>
                        <a href="/perfil" class="p-2 text-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg" title="Meu Perfil">
                            <i class="fas fa-user-edit"></i>
                        </a>
                        <a href="/logout" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg" title="Sair">
                            <i class="fas fa-sign-out-alt"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-4 mb-6">
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-500"></i>
                </div>
                <div>
                    <h3 class="font-medium text-blue-800 dark:text-blue-300">Como funciona</h3>
                    <p class="text-sm text-blue-700 dark:text-blue-400 mt-1">
                        Cada turma representa um curso ou grupo de alunos. Crie uma turma para comecar a planejar as semanas de aula. 
                        Voce pode ter multiplas turmas, cada uma com seu proprio cronograma.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Minhas Turmas</h2>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">Gerencie suas turmas e cursos</p>
                </div>
                <div class="flex gap-2">
                    <a href="/importar" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors flex items-center gap-2">
                        <i class="fas fa-file-import"></i>
                        <span class="hidden sm:inline">Importar Cronograma</span>
                    </a>
                    <button onclick="openModal()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        Nova Turma
                    </button>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <div class="flex flex-wrap gap-2">
                <button id="filter-all" onclick="setFilter('all')" class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm font-medium bg-primary-500 text-white">
                    <i class="fas fa-list"></i>
                    Todas
                    <span id="count-all" class="bg-white/20 px-2 py-0.5 rounded-full text-xs">0</span>
                </button>
                <button id="filter-abertas" onclick="setFilter('abertas')" class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm font-medium bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600">
                    <i class="fas fa-book-open"></i>
                    Abertas
                    <span id="count-abertas" class="bg-gray-300 dark:bg-gray-600 px-2 py-0.5 rounded-full text-xs">0</span>
                </button>
                <button id="filter-encerradas" onclick="setFilter('encerradas')" class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm font-medium bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600">
                    <i class="fas fa-trophy"></i>
                    Encerradas
                    <span id="count-encerradas" class="bg-gray-300 dark:bg-gray-600 px-2 py-0.5 rounded-full text-xs">0</span>
                </button>
            </div>
        </div>

        <div id="turmas-list" class="grid gap-4">
        </div>

        <div id="empty-state" class="hidden text-center py-12">
            <div class="w-20 h-20 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-users text-3xl text-gray-400"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-800 dark:text-white mb-2">Nenhuma turma cadastrada</h3>
            <p class="text-gray-500 dark:text-gray-400 mb-4">Comece criando sua primeira turma para planejar as aulas</p>
            <button onclick="openModal()" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors">
                <i class="fas fa-plus mr-2"></i>
                Criar Turma
            </button>
        </div>

    </main>

    <div id="celebration-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] hidden">
        <div class="celebration-content bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-md mx-4 text-center transform scale-0 transition-transform duration-500">
            <div class="celebration-icon w-24 h-24 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce">
                <i class="fas fa-trophy text-white text-4xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Parabens!</h2>
            <p class="text-lg text-emerald-600 dark:text-emerald-400 font-semibold mb-4" id="celebration-turma-name"></p>
            <p class="text-gray-600 dark:text-gray-300 mb-6">Todas as semanas e capacidades foram concluidas com sucesso! A turma foi movida para a area de Turmas Encerradas.</p>
            <button onclick="closeCelebration()" class="px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white rounded-xl transition-all font-semibold shadow-lg shadow-emerald-500/30">
                <i class="fas fa-check mr-2"></i>
                Continuar
            </button>
        </div>
        <div id="confetti-container" class="fixed inset-0 pointer-events-none overflow-hidden"></div>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden overflow-y-auto">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-lg mx-4 my-8 shadow-xl">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-trophy text-white text-xl"></i>
                    </div>
                    <div>
                        <h3 id="details-title" class="text-lg font-semibold text-gray-800 dark:text-white">Detalhes da Turma</h3>
                        <span class="px-2 py-0.5 bg-emerald-500 text-white text-xs rounded-full font-medium">Encerrada</span>
                    </div>
                </div>
                <button onclick="closeDetailsModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                    <i class="fas fa-times text-gray-500"></i>
                </button>
            </div>
            <div id="details-content" class="space-y-4">
            </div>
            <div class="mt-6 flex gap-3">
                <button onclick="closeDetailsModal()" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-colors">
                    Fechar
                </button>
                <button id="details-schedule-btn" class="flex-1 px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-calendar-alt"></i>
                    Ver Cronograma
                </button>
            </div>
        </div>
    </div>

    <style>
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confetti-fall 3s linear forwards;
        }
        @keyframes slide-out-right {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }
        @keyframes slide-in-left {
            0% { transform: translateX(-100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        .slide-out { animation: slide-out-right 0.5s ease-in-out forwards; }
        .slide-in { animation: slide-in-left 0.5s ease-in-out forwards; }
    </style>

    <div id="modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden overflow-y-auto">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-lg mx-4 my-8 shadow-xl">
            <div class="flex items-center justify-between mb-6">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-800 dark:text-white">Nova Turma</h3>
                <button onclick="closeModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                    <i class="fas fa-times text-gray-500"></i>
                </button>
            </div>
            <form id="turma-form" onsubmit="saveTurma(event)">
                <input type="hidden" id="turma-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome da Turma</label>
                    <input type="text" id="turma-nome" required
                        class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-0 rounded-lg focus:ring-2 focus:ring-primary-500 dark:text-white"
                        placeholder="Ex: Tecnico em Programacao de Jogos Digitais">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Descricao (opcional)</label>
                    <textarea id="turma-descricao" rows="2"
                        class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-0 rounded-lg focus:ring-2 focus:ring-primary-500 dark:text-white resize-none"
                        placeholder="Descricao da turma..."></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Carga Horaria (horas)</label>
                    <input type="number" id="turma-carga-horaria" min="0"
                        class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-0 rounded-lg focus:ring-2 focus:ring-primary-500 dark:text-white"
                        placeholder="Ex: 400">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Dias de Aula</label>
                    <div class="flex flex-wrap gap-2" id="dias-aula-container">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="seg" class="dia-checkbox w-4 h-4 text-primary-500 rounded">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Seg</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="ter" class="dia-checkbox w-4 h-4 text-primary-500 rounded">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Ter</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="qua" class="dia-checkbox w-4 h-4 text-primary-500 rounded">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Qua</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="qui" class="dia-checkbox w-4 h-4 text-primary-500 rounded">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Qui</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="sex" class="dia-checkbox w-4 h-4 text-primary-500 rounded">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Sex</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="sab" class="dia-checkbox w-4 h-4 text-primary-500 rounded">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Sab</span>
                        </label>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Horario Inicio</label>
                        <input type="time" id="turma-horario-inicio"
                            class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-0 rounded-lg focus:ring-2 focus:ring-primary-500 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Horario Fim</label>
                        <input type="time" id="turma-horario-fim"
                            class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-0 rounded-lg focus:ring-2 focus:ring-primary-500 dark:text-white">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data Inicio</label>
                        <input type="date" id="turma-data-inicio"
                            class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-0 rounded-lg focus:ring-2 focus:ring-primary-500 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data Fim</label>
                        <input type="date" id="turma-data-fim"
                            class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-0 rounded-lg focus:ring-2 focus:ring-primary-500 dark:text-white">
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cor</label>
                    <div class="flex gap-2 flex-wrap">
                        <button type="button" onclick="selectColor('blue')" class="color-btn w-8 h-8 rounded-full bg-blue-500 hover:ring-2 hover:ring-offset-2 hover:ring-blue-500" data-color="blue"></button>
                        <button type="button" onclick="selectColor('green')" class="color-btn w-8 h-8 rounded-full bg-green-500 hover:ring-2 hover:ring-offset-2 hover:ring-green-500" data-color="green"></button>
                        <button type="button" onclick="selectColor('purple')" class="color-btn w-8 h-8 rounded-full bg-purple-500 hover:ring-2 hover:ring-offset-2 hover:ring-purple-500" data-color="purple"></button>
                        <button type="button" onclick="selectColor('red')" class="color-btn w-8 h-8 rounded-full bg-red-500 hover:ring-2 hover:ring-offset-2 hover:ring-red-500" data-color="red"></button>
                        <button type="button" onclick="selectColor('orange')" class="color-btn w-8 h-8 rounded-full bg-orange-500 hover:ring-2 hover:ring-offset-2 hover:ring-orange-500" data-color="orange"></button>
                        <button type="button" onclick="selectColor('teal')" class="color-btn w-8 h-8 rounded-full bg-teal-500 hover:ring-2 hover:ring-offset-2 hover:ring-teal-500" data-color="teal"></button>
                        <button type="button" onclick="selectColor('pink')" class="color-btn w-8 h-8 rounded-full bg-pink-500 hover:ring-2 hover:ring-offset-2 hover:ring-pink-500" data-color="pink"></button>
                        <button type="button" onclick="selectColor('indigo')" class="color-btn w-8 h-8 rounded-full bg-indigo-500 hover:ring-2 hover:ring-offset-2 hover:ring-indigo-500" data-color="indigo"></button>
                    </div>
                    <input type="hidden" id="turma-cor" value="blue">
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let selectedColor = 'blue';
        let currentFilter = 'all';
        let allTurmasAbertas = [];
        let allTurmasEncerradas = [];
        
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }

        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }

        function setFilter(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.classList.remove('bg-primary-500', 'text-white');
                btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            });
            
            const activeBtn = document.getElementById(`filter-${filter}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                activeBtn.classList.add('bg-primary-500', 'text-white');
            }
            
            renderFilteredTurmas();
        }

        function updateFilterCounts() {
            document.getElementById('count-all').textContent = allTurmasAbertas.length + allTurmasEncerradas.length;
            document.getElementById('count-abertas').textContent = allTurmasAbertas.length;
            document.getElementById('count-encerradas').textContent = allTurmasEncerradas.length;
        }

        function renderFilteredTurmas() {
            const list = document.getElementById('turmas-list');
            const emptyState = document.getElementById('empty-state');
            
            let turmasToShow = [];
            
            if (currentFilter === 'all') {
                turmasToShow = [
                    ...allTurmasAbertas.map(t => ({ ...t, isEncerrada: false })),
                    ...allTurmasEncerradas.map(t => ({ ...t, isEncerrada: true }))
                ];
            } else if (currentFilter === 'abertas') {
                turmasToShow = allTurmasAbertas.map(t => ({ ...t, isEncerrada: false }));
            } else if (currentFilter === 'encerradas') {
                turmasToShow = allTurmasEncerradas.map(t => ({ ...t, isEncerrada: true }));
            }
            
            if (turmasToShow.length === 0) {
                list.innerHTML = '';
                emptyState.classList.remove('hidden');
                
                if (currentFilter === 'encerradas') {
                    emptyState.querySelector('h3').textContent = 'Nenhuma turma encerrada';
                    emptyState.querySelector('p').textContent = 'As turmas concluidas aparecerao aqui';
                } else if (currentFilter === 'abertas') {
                    emptyState.querySelector('h3').textContent = 'Nenhuma turma aberta';
                    emptyState.querySelector('p').textContent = 'Crie uma nova turma para comecar';
                } else {
                    emptyState.querySelector('h3').textContent = 'Nenhuma turma cadastrada';
                    emptyState.querySelector('p').textContent = 'Comece criando sua primeira turma para planejar as aulas';
                }
            } else {
                emptyState.classList.add('hidden');
                list.innerHTML = turmasToShow.map(turma => renderTurmaCard(turma, turma.isEncerrada)).join('');
            }
        }

        function selectColor(color) {
            selectedColor = color;
            document.getElementById('turma-cor').value = color;
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2');
                if (btn.dataset.color === color) {
                    btn.classList.add('ring-2', 'ring-offset-2', `ring-${color}-500`);
                }
            });
        }

        function setDiasAula(diasStr) {
            document.querySelectorAll('.dia-checkbox').forEach(cb => cb.checked = false);
            if (diasStr) {
                const dias = diasStr.split(',').map(d => d.trim());
                dias.forEach(dia => {
                    const cb = document.querySelector(`.dia-checkbox[value="${dia}"]`);
                    if (cb) cb.checked = true;
                });
            }
        }

        function getDiasAula() {
            const checked = [];
            document.querySelectorAll('.dia-checkbox:checked').forEach(cb => {
                checked.push(cb.value);
            });
            return checked.join(',');
        }

        function openModal(turma = null) {
            document.getElementById('modal').classList.remove('hidden');
            if (turma) {
                document.getElementById('modal-title').textContent = 'Editar Turma';
                document.getElementById('turma-id').value = turma.id;
                document.getElementById('turma-nome').value = turma.nome;
                document.getElementById('turma-descricao').value = turma.descricao || '';
                document.getElementById('turma-carga-horaria').value = turma.carga_horaria || '';
                setDiasAula(turma.dias_aula || '');
                document.getElementById('turma-horario-inicio').value = turma.horario_inicio || '';
                document.getElementById('turma-horario-fim').value = turma.horario_fim || '';
                document.getElementById('turma-data-inicio').value = turma.data_inicio || '';
                document.getElementById('turma-data-fim').value = turma.data_fim || '';
                selectColor(turma.cor || 'blue');
            } else {
                document.getElementById('modal-title').textContent = 'Nova Turma';
                document.getElementById('turma-id').value = '';
                document.getElementById('turma-nome').value = '';
                document.getElementById('turma-descricao').value = '';
                document.getElementById('turma-carga-horaria').value = '';
                setDiasAula('');
                document.getElementById('turma-horario-inicio').value = '';
                document.getElementById('turma-horario-fim').value = '';
                document.getElementById('turma-data-inicio').value = '';
                document.getElementById('turma-data-fim').value = '';
                selectColor('blue');
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function getColorClass(color) {
            const colors = {
                'blue': 'bg-blue-500',
                'green': 'bg-green-500',
                'purple': 'bg-purple-500',
                'red': 'bg-red-500',
                'orange': 'bg-orange-500',
                'teal': 'bg-teal-500',
                'pink': 'bg-pink-500',
                'indigo': 'bg-indigo-500'
            };
            return colors[color] || 'bg-blue-500';
        }

        function goToSchedule(turmaId) {
            localStorage.setItem('selectedTurmaId', turmaId);
            window.location.href = '/';
        }

        function showTurmaDetails(turma) {
            const modal = document.getElementById('details-modal');
            const title = document.getElementById('details-title');
            const content = document.getElementById('details-content');
            const scheduleBtn = document.getElementById('details-schedule-btn');
            
            title.textContent = turma.nome;
            
            const diasMap = {'seg': 'Segunda', 'ter': 'Terca', 'qua': 'Quarta', 'qui': 'Quinta', 'sex': 'Sexta', 'sab': 'Sabado'};
            const diasFormatted = turma.dias_aula ? turma.dias_aula.split(',').map(d => diasMap[d.trim()] || d).join(', ') : 'Nao definido';
            const formatDate = (d) => d ? new Date(d + 'T00:00:00').toLocaleDateString('pt-BR') : 'Nao definida';
            const dataConclusao = turma.data_conclusao ? new Date(turma.data_conclusao).toLocaleDateString('pt-BR') : '';
            
            content.innerHTML = `
                <div class="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-lg p-4">
                    <div class="flex items-center gap-2 text-emerald-700 dark:text-emerald-300">
                        <i class="fas fa-check-circle"></i>
                        <span class="font-medium">Turma concluida em ${dataConclusao}</span>
                    </div>
                </div>
                
                ${turma.descricao ? `
                <div>
                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Descricao</label>
                    <p class="text-gray-800 dark:text-white">${turma.descricao}</p>
                </div>` : ''}
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Semanas</label>
                        <p class="text-gray-800 dark:text-white font-semibold">${turma.schedule_count || 0} semanas</p>
                    </div>
                    ${turma.carga_horaria ? `
                    <div>
                        <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Carga Horaria</label>
                        <p class="text-gray-800 dark:text-white font-semibold">${turma.carga_horaria} horas</p>
                    </div>` : ''}
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Data Inicio</label>
                        <p class="text-gray-800 dark:text-white">${formatDate(turma.data_inicio)}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Data Fim</label>
                        <p class="text-gray-800 dark:text-white">${formatDate(turma.data_fim)}</p>
                    </div>
                </div>
                
                ${turma.dias_aula ? `
                <div>
                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Dias de Aula</label>
                    <p class="text-gray-800 dark:text-white">${diasFormatted}</p>
                </div>` : ''}
                
                ${turma.horario_inicio && turma.horario_fim ? `
                <div>
                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Horario</label>
                    <p class="text-gray-800 dark:text-white">${turma.horario_inicio} - ${turma.horario_fim}</p>
                </div>` : ''}
            `;
            
            scheduleBtn.onclick = () => {
                closeDetailsModal();
                goToSchedule(turma.id);
            };
            
            modal.classList.remove('hidden');
        }

        function closeDetailsModal() {
            document.getElementById('details-modal').classList.add('hidden');
        }

        async function loadTurmas() {
            try {
                const [abertasResponse, encerradasResponse] = await Promise.all([
                    fetch('/api/turmas'),
                    fetch('/api/turmas-encerradas')
                ]);
                
                allTurmasAbertas = await abertasResponse.json();
                allTurmasEncerradas = await encerradasResponse.json();
                
                updateFilterCounts();
                renderFilteredTurmas();
            } catch (error) {
                console.error('Erro ao carregar turmas:', error);
            }
        }

        function renderTurmaCard(turma, isEncerrada) {
            const diasMap = {'seg': 'Seg', 'ter': 'Ter', 'qua': 'Qua', 'qui': 'Qui', 'sex': 'Sex', 'sab': 'Sab'};
            const diasFormatted = turma.dias_aula ? turma.dias_aula.split(',').map(d => diasMap[d.trim()] || d).join(', ') : '';
            const horarioFormatted = turma.horario_inicio && turma.horario_fim ? `${turma.horario_inicio} - ${turma.horario_fim}` : '';
            const formatDate = (d) => d ? new Date(d + 'T00:00:00').toLocaleDateString('pt-BR') : '';
            const dataFormatted = turma.data_inicio || turma.data_fim ? `${formatDate(turma.data_inicio)} a ${formatDate(turma.data_fim)}` : '';
            const dataConclusao = turma.data_conclusao ? new Date(turma.data_conclusao).toLocaleDateString('pt-BR') : '';
            
            const bgClass = isEncerrada ? 'bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 border-emerald-200 dark:border-emerald-800' : 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700';
            const iconBg = isEncerrada ? 'bg-gradient-to-br from-emerald-500 to-teal-600' : getColorClass(turma.cor);
            const icon = isEncerrada ? 'fa-trophy' : 'fa-users';
            
            let buttons = '';
            if (isEncerrada) {
                buttons = `
                    <button onclick='showTurmaDetails(${JSON.stringify(turma).replace(/'/g, "&#39;")})' class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors flex items-center gap-2 text-sm">
                        <i class="fas fa-eye"></i>
                        <span class="hidden sm:inline">Visualizar</span>
                    </button>
                    <button onclick="restaurarTurma(${turma.id})" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg transition-colors flex items-center gap-2 text-sm" title="Restaurar Turma">
                        <i class="fas fa-undo"></i>
                        <span class="hidden sm:inline">Restaurar</span>
                    </button>
                    <button onclick="openDuplicarModal(${turma.id}, '${turma.nome.replace(/'/g, "\\'")}')" class="p-2 text-purple-500 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded-lg transition-colors" title="Duplicar Turma">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button onclick='openModal(${JSON.stringify(turma).replace(/'/g, "&#39;")})' class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteTurma(${turma.id})" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            } else {
                buttons = `
                    <button onclick="goToSchedule(${turma.id})" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors flex items-center gap-2 text-sm">
                        <i class="fas fa-calendar-alt"></i>
                        <span class="hidden sm:inline">Cronograma</span>
                    </button>
                    <button onclick="openDuplicarModal(${turma.id}, '${turma.nome.replace(/'/g, "\\'")}')" class="p-2 text-purple-500 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded-lg transition-colors" title="Duplicar Turma">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button onclick="checkEncerrarTurma(${turma.id}, '${turma.nome.replace(/'/g, "\\'")}')" class="p-2 text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 rounded-lg transition-colors" title="Encerrar Turma">
                        <i class="fas fa-check-double"></i>
                    </button>
                    <button onclick='openModal(${JSON.stringify(turma).replace(/'/g, "&#39;")})' class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteTurma(${turma.id})" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            }
            
            return `
            <div class="${bgClass} rounded-xl p-5 border hover:shadow-md transition-all" id="turma-card-${turma.id}">
                <div class="flex items-start gap-4">
                    <div class="w-14 h-14 ${iconBg} rounded-xl flex items-center justify-center flex-shrink-0 shadow-lg">
                        <i class="fas ${icon} text-white text-2xl"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white truncate">${turma.nome}</h3>
                            ${isEncerrada ? '<span class="px-2 py-0.5 bg-emerald-500 text-white text-xs rounded-full font-medium">Concluida</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 truncate">${turma.descricao || 'Sem descricao'}</p>
                        <div class="flex flex-wrap items-center gap-3 mt-2 text-xs text-gray-500 dark:text-gray-400">
                            <span><i class="fas fa-calendar-week mr-1"></i>${turma.schedule_count || 0} semanas</span>
                            ${turma.carga_horaria ? `<span><i class="fas fa-clock mr-1"></i>${turma.carga_horaria}h</span>` : ''}
                            ${diasFormatted ? `<span><i class="fas fa-calendar-day mr-1"></i>${diasFormatted}</span>` : ''}
                            ${horarioFormatted ? `<span><i class="fas fa-hourglass-half mr-1"></i>${horarioFormatted}</span>` : ''}
                        </div>
                        ${dataFormatted ? `<div class="mt-1 text-xs text-gray-400 dark:text-gray-500"><i class="fas fa-calendar-alt mr-1"></i>${dataFormatted}</div>` : ''}
                        ${isEncerrada && dataConclusao ? `<div class="mt-1 text-xs text-emerald-600 dark:text-emerald-400 font-medium"><i class="fas fa-trophy mr-1"></i>Concluida em ${dataConclusao}</div>` : ''}
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        ${buttons}
                    </div>
                </div>
            </div>
            `;
        }

        function checkEncerrarTurma(turmaId, turmaNome) {
            fetch(`/api/turmas/${turmaId}/check-conclusao`)
                .then(response => response.json())
                .then(data => {
                    if (data.ja_encerrada) {
                        alert('Esta turma ja esta encerrada.');
                        return;
                    }
                    
                    if (data.pode_encerrar) {
                        if (confirm(`Todas as semanas e capacidades estao concluidas!\n\nDeseja encerrar a turma "${turmaNome}"?`)) {
                            encerrarTurma(turmaId, turmaNome);
                        }
                    } else {
                        const msg = `Ainda nao e possivel encerrar esta turma.\n\n` +
                            `Progresso atual:\n` +
                            `- Semanas: ${data.semanas_concluidas}/${data.total_semanas}\n` +
                            `- Capacidades: ${data.capacidades_concluidas}/${data.total_capacidades}\n\n` +
                            `${data.motivo}`;
                        alert(msg);
                    }
                });
        }

        function encerrarTurma(turmaId, turmaNome) {
            fetch(`/api/turmas/${turmaId}/encerrar`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    
                    const card = document.getElementById(`turma-card-${turmaId}`);
                    if (card) card.classList.add('slide-out');
                    
                    setTimeout(() => {
                        showCelebration(turmaNome);
                        loadTurmas();
                    }, 500);
                });
        }

        function restaurarTurma(turmaId) {
            if (!confirm('Deseja restaurar esta turma? Ela voltara para a lista de turmas ativas.')) return;
            
            fetch(`/api/turmas/${turmaId}/restaurar`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    
                    const card = document.getElementById(`turma-card-${turmaId}`);
                    if (card) card.classList.add('slide-out');
                    
                    setTimeout(() => {
                        loadTurmas();
                    }, 500);
                });
        }

        function showCelebration(turmaNome) {
            const modal = document.getElementById('celebration-modal');
            const content = modal.querySelector('.celebration-content');
            document.getElementById('celebration-turma-name').textContent = turmaNome;
            
            modal.classList.remove('hidden');
            setTimeout(() => content.classList.remove('scale-0'), 50);
            
            createConfetti();
        }

        function closeCelebration() {
            const modal = document.getElementById('celebration-modal');
            const content = modal.querySelector('.celebration-content');
            content.classList.add('scale-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('confetti-container').innerHTML = '';
            }, 300);
        }

        function createConfetti() {
            const container = document.getElementById('confetti-container');
            const colors = ['#fbbf24', '#34d399', '#60a5fa', '#f472b6', '#a78bfa', '#fb923c'];
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                container.appendChild(confetti);
            }
        }

        function saveTurma(event) {
            event.preventDefault();
            const id = document.getElementById('turma-id').value;
            const nome = document.getElementById('turma-nome').value;
            const descricao = document.getElementById('turma-descricao').value;
            const cor = document.getElementById('turma-cor').value;
            const carga_horaria = parseInt(document.getElementById('turma-carga-horaria').value) || 0;
            const dias_aula = getDiasAula();
            const horario_inicio = document.getElementById('turma-horario-inicio').value;
            const horario_fim = document.getElementById('turma-horario-fim').value;
            const data_inicio = document.getElementById('turma-data-inicio').value;
            const data_fim = document.getElementById('turma-data-fim').value;

            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/turmas/${id}` : '/api/turmas';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nome, descricao, cor, carga_horaria, dias_aula, horario_inicio, horario_fim, data_inicio, data_fim })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                closeModal();
                loadTurmas();
            });
        }

        function deleteTurma(id) {
            if (!confirm('Tem certeza que deseja excluir esta turma? Todas as semanas associadas serao perdidas.')) return;
            
            fetch(`/api/turmas/${id}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    loadTurmas();
                });
        }

        let duplicarTurmaId = null;
        let duplicarTurmaNomeOriginal = '';

        function openDuplicarModal(turmaId, turmaNome) {
            duplicarTurmaId = turmaId;
            duplicarTurmaNomeOriginal = turmaNome;
            document.getElementById('duplicar-turma-nome-original').textContent = turmaNome;
            document.getElementById('duplicar-novo-nome').value = turmaNome + ' (Copia)';
            document.getElementById('duplicar-modal').classList.remove('hidden');
        }

        function closeDuplicarModal() {
            document.getElementById('duplicar-modal').classList.add('hidden');
            duplicarTurmaId = null;
            duplicarTurmaNomeOriginal = '';
        }

        async function confirmarDuplicar() {
            if (!duplicarTurmaId) return;
            
            const novoNome = document.getElementById('duplicar-novo-nome').value.trim();
            if (!novoNome) {
                alert('Por favor, informe um nome para a nova turma.');
                return;
            }
            
            const btn = document.getElementById('btn-confirmar-duplicar');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Duplicando...';
            btn.disabled = true;
            
            try {
                const response = await fetch(`/api/turmas/${duplicarTurmaId}/duplicar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ novo_nome: novoNome })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                closeDuplicarModal();
                loadTurmas();
                
                setTimeout(() => {
                    alert(`Turma duplicada com sucesso!\n${data.schedules_copiados} semanas foram copiadas para a nova turma.`);
                }, 100);
            } catch (error) {
                console.error('Erro ao duplicar turma:', error);
                alert('Erro ao duplicar turma. Tente novamente.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        loadTurmas();
    </script>

    <div id="duplicar-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden overflow-y-auto">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4 my-8 shadow-xl">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-copy text-white text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Duplicar Turma</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Copiar planejamento completo</p>
                    </div>
                </div>
                <button onclick="closeDuplicarModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                    <i class="fas fa-times text-gray-500"></i>
                </button>
            </div>
            
            <div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg p-4 mb-6">
                <div class="flex items-start gap-3">
                    <i class="fas fa-info-circle text-purple-500 mt-0.5"></i>
                    <div class="text-sm text-purple-700 dark:text-purple-300">
                        <p class="font-medium mb-1">O que sera copiado:</p>
                        <ul class="list-disc list-inside space-y-1 text-purple-600 dark:text-purple-400">
                            <li>Todas as semanas do cronograma</li>
                            <li>Atividades, capacidades e conhecimentos</li>
                            <li>Configuracoes da turma (dias, horarios, etc)</li>
                        </ul>
                        <p class="mt-2 text-purple-500 dark:text-purple-400"><strong>Nota:</strong> O progresso das semanas sera zerado na nova turma.</p>
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Turma Original</label>
                <p id="duplicar-turma-nome-original" class="text-gray-800 dark:text-white font-medium"></p>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome da Nova Turma</label>
                <input type="text" id="duplicar-novo-nome" required
                    class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-0 rounded-lg focus:ring-2 focus:ring-purple-500 dark:text-white"
                    placeholder="Digite o nome da nova turma">
            </div>
            
            <div class="flex gap-3">
                <button type="button" onclick="closeDuplicarModal()" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button type="button" id="btn-confirmar-duplicar" onclick="confirmarDuplicar()" class="flex-1 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-copy"></i>
                    Duplicar Turma
                </button>
            </div>
        </div>
    </div>
</body>
</html>
